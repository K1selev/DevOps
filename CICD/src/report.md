# Basic CI/CD

### Part 1. Настройка **gitlab-runner**

##### Поднять виртуальную машину *Ubuntu Server 20.04 LTS*
*Будьте готовы, что в конце проекта нужно будет сохранить дамп образа виртуальной машины*

##### Скачать и установить на виртуальную машину **gitlab-runner**
- sudo apt install gitlab-runner
![install](screens/1.1.png)

##### Запустить **gitlab-runner** и зарегистрировать его для использования в текущем проекте (*DO6_CICD*)
- Для регистрации понадобятся URL и токен, которые можно получить на страничке задания на платформе.
- gitlab-runner register
![register_runner](screens/1.2.png)

### Part 2. Сборка

#### Написать этап для **CI** по сборке приложений из проекта *C2_SimpleBashUtils*:

##### В файле _gitlab-ci.yml_ добавить этап запуска сборки через мейк файл из проекта _C2_

##### Файлы, полученные после сборки (артефакты), сохранять в произвольную директорию со сроком хранения 30 дней.
- добавим инструкцию в .yml
![build](screens/2.1.png)
- проверка работы
![pipeline](screens/2.2.png)
![job](screens/2.3.png)

### Part 3. Тест кодстайла

`-` Поздравляю, вы выполнили абсолютно бессмысленную задачу. Шучу. Она была нужна для перехода ко всем последующим.

**== Задание ==**

#### Написать этап для **CI**, который запускает скрипт кодстайла (*clang-format*):
- добавим инструкцию в .yml
![build](screens/3.1.png)
##### Если кодстайл не прошел, то "зафейлить" пайплайн
##### В пайплайне отобразить вывод утилиты *clang-format*
- скрипт для проверки
![script_check](screens/3.11.png)
- тесты на стиль пройдены
![style_pipeline_ok](screens/3.2.png)
![style_job_ok](screens/3.3.png)
- тесты на стиль провалены
![style_pipeline_fail](screens/3.5.png)
![style_job_fail](screens/3.4.png)


### Part 4. Интеграционные тесты

#### Написать этап для **CI**, который запускает ваши интеграционные тесты из того же проекта:
- добавим инструкцию в .yml
![unit_test](screens/4.1.png)
- скрипт для интеграционных тестов
![unit_script](screens/4.2.png)
##### Запускать этот этап автоматически только при условии, если сборка и тест кодстайла прошли успешно

##### Если тесты не прошли, то "зафейлить" пайплайн

##### В пайплайне отобразить вывод, что интеграционные тесты успешно прошли / провалились
- интеграционные тесты пройдены
![unit_pipeline_ok](screens/4.4.png)
![unit_job_ok](screens/4.3.png)
- интеграционные тесты провалены
![unit_pipeline_fail](screens/4.5.png)
![unit_job_fail](screens/4.55.png)
- прерывание процесса при фейле предыдущего этапа
![unit_prev_fail](screens/4.6.png)



### Part 5. Этап деплоя

##### Поднять вторую виртуальную машину *Ubuntu Server 20.04 LTS*
- yaml-файлы
![yaml1](screens/5.1.png)
![yaml2](screens/5.2.png)
- машины пингуются
![ping](screens/5.3.png)
- настройка второй виртуальной машины
![ssh2](screens/5.4.png)
- подключение ко второй машине через ssh без необходимости ввода пароля
![ssh_key](screens/5.66.png)
![ssh](screens/5.6.png)
#### Написать этап для **CD**, который "разворачивает" проект на другой виртуальной машине:
##### Запускать этот этап вручную при условии, что все предыдущие этапы прошли успешно
- добавим инструкцию в .yml

![manual](screens/5.11.png)

##### Написать bash-скрипт, который при помощи **ssh** и **scp** копирует файлы, полученные после сборки (артефакты), в директорию */usr/local/bin* второй виртуальной машины
*Тут вам могут помочь знания, полученные в проекте DO2_LinuxNetwork*
- bash скрипт deploy
![script](screens/5.10.png)

##### В файле _gitlab-ci.yml_ добавить этап запуска написанного скрипта

##### В случае ошибки "зафейлить" пайплайн

В результате вы должны получить готовые к работе приложения из проекта *C2_SimpleBashUtils* (s21_cat и s21_grep) на второй виртуальной машине.
- deploy на gitlab
![deploy_1](screens/5.7.png)
![deploy_2](screens/5.8.png)
![deploy_3](screens/5.9.png)
### Part 6. Дополнительно. Уведомления

##### Настроить уведомления о успешном/неуспешном выполнении пайплайна через бота с именем "[ваш nickname] DO6 CI/CD" в *Telegram*
- пишем @BotFather в телеграм, создаём бота, получаем токен.
![father_bot](screens/6.1.png)
- скрипт для работы бота
![bot_script](screens/6.4.png)
- добавляем вызов скрипта после каждого этапа в .gitlab-ci.yml
![call_bot](screens/6.3.png)
- Текст уведомления должен содержать информацию об успешности прохождения как этапа **CI**, так и этапа **CD**.
- В остальном текст уведомления может быть произвольным.
- результат
![result](screens/6.5.png)
